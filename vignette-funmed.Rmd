---
title: "Demonstrating functional mediation"
author: "John J. Dziak"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Demonstrating functional mediation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

* Introduction 

The funmediation package provides software for exploring functional mediation in a sample of   intensive longitudinal data from multiple individuals. It assumes a dichotomous non-time-varying randomized treatment or exposure $X$, a distal outcome $Y$ observed at one time point, and a time-varying mediator $M(t)$.  The mediator is assumed to be measured as intensive longitudinal data.  The research question is whether it can be shown that the effect of $X$ on $Y$ is mediated by the process $M(t)$.  This situation was first studied by Lindquist (2012, JASA).  $M(t)$ can be numerical or binary, and $Y$ can also be either numerical or binary;  $X$ is assumed to be binary.

* Notation

The mediation model is fit in stages.  First, the effect of $X$ on $M$ is fit behind the scenes as a time-varying effects (varying coefficients) model using the tvem package in R.  The assumed mean model is
$E(M_i(t)) = \alpha_0(t) + \alpha_1(t) X_i$
for numerical $M(t)$, or
$\mathrm{logit}^{-1}(E(M_i(t))) = \alpha_0(t) + \alpha_1(t) X_i$ 
for binary $M(t)$. 
This is fit as a marginal model: that is, without random effects but with a sandwich covariance estimate to handle within-subject correlation, as in working-independence generalized estimating equations.

Next, the effect of $M$ on $X$ is modeled as a scalar-on-function functional regression using the pfr function in the refund R package. 



Covariates can be included in predicting $M(t)$ and $Y$.  For convenience of notation, we assume a single subject-level covariate $S$ which predicts $M(t)$ and $Y$ and a single time-varying covariate $Z(t)$ which also predicts $M(t)$.  

First we load the required packages.  

```{r}
library(tvem)
library(refund)
library(boot)
library(funmediation)
```
 
 
We then simulate data.  The info1 object will contain not only the simulated dataset, but the true values of the simulated parameters, including the indirect effect. 

```{r}
set.seed(123);
info1 <- simulate_funmediation_example();
the_data <- info1$dataset;
```

Now call the functional mediation function.  Only 19 bootstrap samples are used below for the illustration.  Only 9 bootstraps allows  possible p-values of .05, .10, ..., 1.0.  At least 199 bootstraps is recommended in practice in order to increase precision and power, allowing p-values of .005, .010, .015, ....

```{r}
model1 <- funmediation(data=the_data,
                             treatment=X,
                             mediator=M,
                             outcome=Y,
                             id=subject_id,
                             time=t,
                             nboot=19);			
```

We can print and plot the results.

```{r}
print(model1);
plot(model1);
```
  

* Acknowledgements

The pfr function was developed by Jonathan Gellar, Mathew W. McLean, Jeff Goldsmith, and Fabian Scheipl, and the refund package was developed and maintained by Julia Wrobel and others
