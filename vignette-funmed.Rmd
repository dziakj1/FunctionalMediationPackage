---
title: "Demonstrating functional mediation"
author: "John J. Dziak"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Demonstrating functional mediation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction 

The ``funmediation`` package fits a functional mediation model to intensive longitudinal data on a sample of multiple individuals. For each individual $i$, the model assumes a dichotomous non-time-varying randomized treatment or exposure $X_i$, a distal outcome $Y_i$ observed at one time point, and a time-varying mediator $M_i(t)$ observed repeatedly during the interval after $X_i$ is observed and before $Y_i$ is observed.  The research question is whether the effect of $X_i$ on $Y_i$ is mediated by the process $M_i(t)$.  This kind of model was first studied by Lindquist (2012, JASA).  $M_i(t)$ can be numerical or binary, and $Y_i$ can also be either numerical or binary;  $X_i$ is assumed to be binary.

# Notation

The mediation model for ``funmediation`` is fit in stages.  First, the effect of $X_i$ on $M_i$ is fit behind the scenes as a time-varying effects (longitudinal varying coefficients) model (see Hastie and Tibshirani, 1993; Tan et al., 2012) using the ``tvem`` package.  The assumed mean model is
$E(M_i(t)) = \alpha_0(t) + \alpha_X(t) X_i$
for numerical $M_i(t)$, or
$\mathrm{logit}^{-1}(E(M_i(t))) = \alpha_0(t) + \alpha_X(t) X_i$ 
for binary $M_i(t)$. 
This fits the marginal (population-averaged) mean: that is, without random effects but with a sandwich covariance estimate to handle within-subject correlation, as in working-independence generalized estimating equations.

Next, the effect of $X_i$ and $M_i(t)$ on $Y_i$ is modeled as a scalar-on-function functional regression (see Goldsmith et al., 2011) using the ``pfr`` function in the ``refund`` package. 
The assumed mean model is
$E(Y_i) = \beta_0 + \beta_{X}X_i+ \int\beta_M(t)M_i(t)dt$
for numerical $Y_i$, or
$\mathrm{logit}^{-1}(E(Y_i)) = \beta_0 + \beta_{X}X_i+ \int\beta_M(t)M_i(t)dt$
for binary $Y_i$. 

The indirect effect is calculated as the integral $\int \alpha_X(t)\beta_M(t)$.
Because these functions are actually only estimated on a grid of points, the integral is actually approximated as a weighted average of the cross-products of the estimates. We obtain a bootstrap confidence interval for this quantity using the ``boot`` package.

# Including Covariates

Covariates can be included in predicting $M_i(t)$ and $Y_i$.  For example, suppose there is a  covariate $Z_i(t)$ which has a time-varying relationship to $M_i(t)$.  The TVEM model for the mediator can be expanded to 
$E(M_i(t)) = \alpha_0(t) + \alpha_X(t) X_i + \alpha_Z(t) Z_i(t)$
for numerical $M_i(t)$, or
$\mathrm{logit}^{-1}(E(M_i(t))) = \alpha_0(t) + \alpha_X(t) X_i+ \alpha_Z(t) Z_i(t)$ 
for binary $M_i(t)$. 
It is possible for $Z_i$ to have a time-varying effect even if the values of $Z$ do not vary over time.  That would mean that the correlation between the observation-level $M_i(t)$ and the subject-level $Z_i$ is different for different values of $t$.  In this case, $Z_i(t)$ can simply be written as $Z_i$.  It is also possible to assume that the relationship between $Z_i$ and $M_i(t)$ does not depend on $t$, whether or not $Z_i$ depends on $t$;  in this case $\alpha_Z(t)$ can simply be written as $\alpha_Z$.  The package allows both time-varying-effects and time-invariant-effects covariates to be specified in predicting the mediator, using the ``tve_covariates_on_mediator`` and ``tie_covariates_on_mediator`` arguments respectively.

Alternatively, suppose that there is a subject-level covariate $S_i$ which predicts $Y_i$.  This can be added to the functional regression model by specifying
$E(Y_i) = \beta_0 + \beta_{X}X_i+ \beta_S S_i + \int\beta_M(t)M_i(t)dt$
for numerical $Y_i$, or
$\mathrm{logit}^{-1}(E(Y_i)) = \beta_0 + \beta_{X}X_i+ \beta_S S_i + \int\beta_M(t)M_i(t)dt$
for binary $Y_i$.  Such a covariate can be included using the ``covariates_on_outcome`` argument in the package. Currently, the package assumes a subject-level $Y_i$ and does not support multiple functional coefficients in predicting the outcome; that is, the covariates in ``covariates_on_outcome`` cannot have time-varying values or effects.

# Example

The following example shows how to simulate example data and then analyze it using the ``funmediation`` package.

## Getting ready to run the example

First we load the required packages.  

```{r}
library(tvem)
library(refund)
library(boot)
library(funmediation)
```
 
 We then simulate data.  The ``info1`` object will contain not only the simulated dataset, but the true values of the simulated parameters, including the indirect effect. 

```{r}
set.seed(123);
info1 <- simulate_funmediation_example();
the_data <- info1$dataset;
```

We can use the ``head`` and ``summary`` function in R, in order to look at the first few lines of the data
```{r}
print(head(the_data));
```

We can also look at univariate descriptive statistics:
```{r}
summary(the_data);
```

It would be reasonable to do other descriptive analyses also, but in order to demonstrate the function we proceed directly to the main analysis.

# Running a Functional Mediation Model

Now call the functional mediation function.  Only 20 bootstrap samples are used below for the illustration.  At least a few hundred bootstraps is recommended in practice in order to increase precision and power.

```{r}
model1 <- funmediation(data=the_data,
                             treatment=X,
                             mediator=M,
                             outcome=Y,
                             id=subject_id,
                             time=t,
                             nboot=20);			
```

The `print` function gives an initial overview of the results.

```{r}
print(model1);
```

The `plot` function plots the results.  Three kinds of plots are available, represented by the options `coef`, `tvem`, and `pfr.`

```{r}
plot(model1, what_plot="coef");
```

```{r}
plot(model1, what_plot="tvem");
```

```{r}
plot(model1, what_plot="pfr");
```

                  
## Interpreting the Output

  
## Exploring Information in the Output Objects
  
  
## Including Covariates


# Binary Outcomes

```{r}
set.seed(123);
info2 <- simulate_funmediation_example(simulate_binary_Y=TRUE);
the_data_binary <- info2$dataset;
head(the_data_binary)
```



```{r}
model2 <- funmediation(data=the_data_binary,
                             treatment=X,
                             mediator=M,
                             outcome=Y,
                             id=subject_id,
                             time=t,
                             binary_outcome=TRUE,
                             nboot=20);			
```

```{r}
print(model2);
```



```{r}
plot(model1, what_plot="coef");
```



```{r}
plot(model1, what_plot="tvem");
```


```{r}
plot(model1, what_plot="pfr");
```

# Binary Mediators


# Discussion


# References


* Goldsmith, J., Bobb, J., Crainiceanu, C., Caffo, B., and Reich, D. (2011). Penalized functional regression. Journal of Computational and Graphical Statistics, 20(4), 830-851.

* Hastie, T, Tibshirani, R. (1993). Varying-coefficient models. Journal of the Royal Statistical Socety, B, 55:757-796.

* Tan, X., Shiyko, M. P., Li, R., Li, Y., & Dierker, L. (2012). A time-varying effect model for intensive longitudinal data. Psychological Methods, 17: 61-77.


# Acknowledgements

The pfr function was developed by Jonathan Gellar, Mathew W. McLean, Jeff Goldsmith, and Fabian Scheipl, and the refund package was developed and maintained by Julia Wrobel and others
